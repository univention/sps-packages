#!/bin/sh
# postinst script for sps-branding
#
# see: dh_installdeb(1)
#
# Copyright (C) 2021 Univention GmbH
#
# http://www.univention.de/
#
# All rights reserved.
#
# The source code of the software contained in this package
# as well as the source package itself are made available
# under the terms of the GNU Affero General Public License version 3
# (GNU AGPL V3) as published by the Free Software Foundation.
#
# Binary versions of this package provided by Univention to you as
# well as other copyrighted, protected or trademarked materials like
# Logos, graphics, fonts, specific documentations and configurations,
# cryptographic keys etc. are subject to a license agreement between
# you and Univention and not subject to the GNU AGPL V3.
#
# In the case you use the software under the terms of the GNU AGPL V3,
# the program is provided in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public
# License with the Debian GNU/Linux or Univention distribution in file
# /usr/share/common-licenses/AGPL-3; if not, see
# <http://www.gnu.org/licenses/>.


#DEBHELPER#

# Nextcloud

univention-app info | grep nextcloud > /dev/null

if [ $? -eq 0 ]; then
	/usr/bin/univention-app shell nextcloud sudo -u www-data php /var/www/html/occ theming:config color "#F2F2F2"
	nextcloud_docker_id=$(docker ps -a | grep 'nextcloud' -m 1 | awk '{ print $1 }')
	docker cp /usr/share/univention-sps/SPS_Logo.png $nextcloud_docker_id:/var/www/html/themes/
	/usr/bin/univention-app shell nextcloud sudo -u www-data php /var/www/html/occ theming:config logo "/var/www/html/themes/SPS_Logo.png"
fi

# Open-Xchange

univention-app info | grep oxseforucs > /dev/null

if [ $? -eq 0 ]; then
	cp /usr/share/univention-sps/SPS_Logo.png /var/www/appsuite/
	echo "Setting OX maincolor..."
	sed -i "s|io.ox/dynamic-theme//mainColor=.*|io.ox/dynamic-theme//mainColor=#F2F2F2|g" /opt/open-xchange/etc/settings/open-xchange-dynamic-theme.properties
	echo "Setting OX topbarbackground..."
	sed -i "s|io.ox/dynamic-theme//topbarBackground=.*|io.ox/dynamic-theme//topbarBackground=#F2F2F2|g" /opt/open-xchange/etc/settings/open-xchange-dynamic-theme.properties
	echo "Setting OX logo..."
	sed -i "s|io.ox/dynamic-theme//logoWidth=.*|io.ox/dynamic-theme//logoWidth=48|g" /opt/open-xchange/etc/settings/open-xchange-dynamic-theme.properties
	sed -i "s|io.ox/dynamic-theme//logoHeight=.*|io.ox/dynamic-theme//logoHeight=Auto|g" /opt/open-xchange/etc/settings/open-xchange-dynamic-theme.properties
	sed -i "s|io.ox/dynamic-theme//logoURL=.*|io.ox/dynamic-theme//logoURL=SPS_Logo.png|g" /opt/open-xchange/etc/settings/open-xchange-dynamic-theme.properties
	echo "com.openexchange.capability.dynamic-theme=true" >> /opt/open-xchange/etc/settings/open-xchange-dynamic-theme.properties
fi

# restart all services affected by changes
echo "Restarting services..."
service docker-app-nextcloud restart
service open-xchange restart
service univention-portal-server restart

exit 0
